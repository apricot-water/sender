<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Familien Chat</title>
<style>
    /* === VARIABLES & THEME === */
    :root {
        --bg-app: #f2f2f7; --bg-card: #ffffff; --text-main: #000000; --text-sub: #8e8e93;
        --input-bg: #e5e5ea; --accent: #007aff; --danger: #ff3b30; --sidebar-bg: #ffffff;
    }
    body.dark {
        --bg-app: #000000; --bg-card: #1c1c1e; --text-main: #ffffff; --text-sub: #98989f;
        --input-bg: #2c2c2e; --accent: #0a84ff; --sidebar-bg: #1c1c1e;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg-app); color: var(--text-main); height: 100dvh; width: 100vw; overflow: hidden; display: flex; justify-content: center; }

    /* === LAYOUT === */
    .app-wrapper { width: 100%; max-width: 600px; background: var(--bg-card); display: flex; flex-direction: column; height: 100%; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; }
    
    /* === HEADER === */
    .app-header { flex: 0 0 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid var(--input-bg); z-index: 20; background: var(--bg-card); }
    .header-title { font-weight: 700; font-size: 17px; }
    .btn-icon { background: none; border: none; cursor: pointer; color: var(--accent); padding: 8px; display: flex; align-items: center; justify-content: center; }

    /* === SIDEBAR (MENU) === */
    .sidebar-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
    
    .sidebar { position: absolute; top: 0; left: 0; bottom: 0; width: 280px; background: var(--sidebar-bg); z-index: 51; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); padding-top: 60px; display: flex; flex-direction: column; }
    .sidebar.open { transform: translateX(0); }
    
    .menu-item { padding: 15px 20px; font-size: 18px; font-weight: 500; border-bottom: 1px solid var(--input-bg); cursor: pointer; display: flex; align-items: center; gap: 15px; }
    .menu-item:active { background: var(--input-bg); }
    .menu-item.active { color: var(--accent); background: rgba(0,122,255,0.1); }
    
    /* === TABS (CONTENT) === */
    .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; height: 100%; }
    .tab-content.active { display: flex; }

    /* === SENDER STYLES === */
    .scroll-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    input, textarea { width: 100%; background: var(--input-bg); border: none; color: var(--text-main); padding: 16px; border-radius: 12px; font-size: 17px; font-family: inherit; resize: none; }
    input:focus, textarea:focus { outline: none; box-shadow: 0 0 0 2px var(--accent); }
    .label-small { font-size: 13px; color: var(--text-sub); margin-left: 12px; margin-bottom: 6px; font-weight: 500; text-transform: uppercase; }
    .media-upload { background: var(--input-bg); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; border: 2px dashed rgba(128,128,128,0.3); }
    .media-preview-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; display: none; margin-top: 10px; }
    .bottom-bar { padding: 20px; border-top: 1px solid var(--input-bg); padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
    .btn-primary { width: 100%; background: linear-gradient(135deg, #007aff, #005ecb); color: white; font-size: 17px; font-weight: 600; padding: 14px; border: none; border-radius: 12px; cursor: pointer; }
    
    /* === VIEWER STYLES (Mini Version of empf√§nger.html) === */
    .viewer-container { flex: 1; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; color: white; text-align: center; padding: 10px; }
    .viewer-img { max-width: 100%; max-height: 50vh; object-fit: contain; border-radius: 10px; margin-bottom: 15px; display: none; }
    .viewer-text { font-size: 24px; font-weight: bold; line-height: 1.3; max-height: 40vh; overflow-y: auto; width: 100%; }
    .viewer-meta { position: absolute; top: 10px; width: 100%; text-align: center; color: #666; font-size: 12px; }
    .viewer-nav { position: absolute; top: 50%; width: 100%; display: flex; justify-content: space-between; padding: 0 10px; pointer-events: none; }
    .nav-btn { pointer-events: auto; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .nav-btn:active { background: rgba(255,255,255,0.4); }

    /* === SETTINGS MODAL === */
    #settingsModal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-card); z-index: 100; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
    #settingsModal.open { transform: translateY(0); }
    .setting-row { padding: 15px; border-bottom: 1px solid var(--input-bg); }
    
    #toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 200; }
    #toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
/* === PROGRESS OVERLAY === */
    #progressOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
        z-index: 200;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #progressOverlay.open { opacity: 1; pointer-events: auto; }

    .progress-card {
        background: var(--bg-card); width: 80%; max-width: 300px;
        padding: 25px; border-radius: 20px; text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .progress-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
    .progress-status { font-size: 13px; color: var(--text-sub); margin-bottom: 15px; min-height: 1.2em;}

    .progress-track {
        background: var(--input-bg); height: 8px; border-radius: 4px; overflow: hidden; position: relative;
    }
    .progress-bar {
        background: var(--accent); height: 100%; width: 0%;
        transition: width 0.2s; border-radius: 4px;
    }

</style>
</head>
<body>

<div class="app-wrapper">
    <!-- PROGRESS OVERLAY -->
    <div id="progressOverlay">
        <div class="progress-card">
            <div class="progress-title">Sende Nachricht...</div>
            <div id="progressStatus" class="progress-status">Vorbereitung...</div>
            <div class="progress-track">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressPercent" style="font-size:12px; margin-top:5px; color:var(--text-sub)">0%</div>
        </div>
    </div>
    
    <!-- HEADER -->
    <header class="app-header">
        <button class="btn-icon" onclick="toggleSidebar(true)">
            <!-- Hamburger Icon -->
            <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div class="header-title" id="pageTitle">Nachricht schreiben</div>
        <button class="btn-icon" onclick="toggleSettings(true)">‚öôÔ∏è</button>
    </header>

    <!-- SIDEBAR -->
    <div class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <div class="sidebar">
        <div style="padding: 0 20px 20px 20px; font-weight:bold; font-size:20px; color:var(--text-sub)">Men√º</div>
        <div class="menu-item active" onclick="switchTab('send')">‚úçÔ∏è Schreiben</div>
        <div class="menu-item" onclick="switchTab('view')">üëÄ Omas Sicht</div>
        <div style="flex:1"></div>
        <div class="menu-item" style="font-size:14px; color:var(--text-sub)" onclick="toggleDarkMode()">üåô Dark Mode umschalten</div>
    </div>

    <!-- TAB: SENDER -->
    <div id="tab-send" class="tab-content active">
        <div class="scroll-area">
            <div>
                <div class="label-small">Dein Name</div>
                <input id="senderName" placeholder="Name">
            </div>
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="label-small">Nachricht</div>
                <textarea id="msgText" placeholder="Hallo Oma..." style="flex:1; min-height:150px;"></textarea>
            </div>
            <div class="media-upload" onclick="document.getElementById('fileInput').click()">
                <div style="font-size:24px; opacity:0.5">üì∑</div>
                <div id="mediaText" style="font-weight:600; color:var(--accent); margin-top:5px">Foto anh√§ngen</div>
                <img id="imagePreview" class="media-preview-img">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewFile()">
            </div>
        </div>
        <div class="bottom-bar">
            <button id="btnSend" class="btn-primary" onclick="send()">Senden üöÄ</button>
        </div>
    </div>

    <!-- TAB: VIEWER -->
    <div id="tab-view" class="tab-content">
        <div class="viewer-container">
            <div class="viewer-meta" id="viewerMeta">Lade Daten...</div>
            <img id="viewerImg" class="viewer-img">
            <div id="viewerText" class="viewer-text"></div>
            
            <div class="viewer-nav">
                <button class="nav-btn" onclick="viewerNext(-1)">‚ùÆ</button>
                <button class="nav-btn" onclick="viewerNext(1)">‚ùØ</button>
            </div>
        </div>
        <div style="padding:10px; text-align:center; font-size:11px; color:var(--text-sub); background:#000;">
            Vorschau (Aktualisiert alle 30m via GitHub)
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settingsModal">
        <header class="app-header">
            <div class="header-title">Einstellungen</div>
            <button class="btn-icon" onclick="saveConf()">Fertig</button>
        </header>
        <div class="scroll-area">
            <div class="label-small">Kanal Name (ntfy)</div>
            <input id="confTopic" placeholder="oma_geheim">
            <div class="label-small" style="margin-top:15px">Passwort</div>
            <input id="confPass" type="text" placeholder="Geheim">
            
            <hr style="border:0; border-top:1px solid var(--input-bg); margin: 20px 0;">
            <div class="label-small">GitHub User</div>
            <input id="confGhUser" placeholder="z.B. deinUser">
            <div class="label-small" style="margin-top:15px">GitHub Repo</div>
            <input id="confGhRepo" placeholder="z.B. oma-chat">
            <div class="label-small" style="margin-top:15px">GitHub Token (Read-Only)</div>
            <input id="confGhToken" type="password" placeholder="github_pat_...">
            <div style="font-size:11px; color:var(--text-sub); margin-top:5px">Ben√∂tigt f√ºr den Verlauf ("Omas Sicht").</div>
        </div>
    </div>

    <div id="toast">Nachricht gesendet!</div>
</div>

<script>
    // --- 1. MAGIC LINK & CONFIG ---
    let conf = { t: '', p: '', gu: '', gr: '', gt: '' };

    (function initConfig() {
        // Load from storage
        try { Object.assign(conf, JSON.parse(localStorage.getItem('oma_conf_v2') || '{}')); } catch(e){}

        // Check Magic Link (#config=BASE64)
        const hash = window.location.hash;
        if (hash.startsWith('#config=')) {
            try {
                const json = JSON.parse(atob(hash.substring(8)));
                // Merge old and new (allows updating just one field)
                Object.assign(conf, json);
                localStorage.setItem('oma_conf_v2', JSON.stringify(conf));
                history.replaceState(null, null, window.location.pathname);
                alert("Einstellungen importiert! üéâ");
            } catch(e) { alert("Link fehlerhaft."); }
        }

        // Fill settings inputs
        document.getElementById('confTopic').value = conf.t || '';
        document.getElementById('confPass').value = conf.p || '';
        document.getElementById('confGhUser').value = conf.gu || '';
        document.getElementById('confGhRepo').value = conf.gr || '';
        document.getElementById('confGhToken').value = conf.gt || '';

        // Check dark mode
        if (localStorage.getItem('darkmode') === 'true') document.body.classList.add('dark');
    })();

    function saveConf() {
        conf.t = document.getElementById('confTopic').value.trim();
        conf.p = document.getElementById('confPass').value.trim();
        conf.gu = document.getElementById('confGhUser').value.trim();
        conf.gr = document.getElementById('confGhRepo').value.trim();
        conf.gt = document.getElementById('confGhToken').value.trim();
        localStorage.setItem('oma_conf_v2', JSON.stringify(conf));
        toggleSettings(false);
        // Reload viewer if active
        if(activeTab === 'view') loadViewerData();
    }

    // --- 2. UI NAVIGATION ---
    let activeTab = 'send';
    function toggleSidebar(open) {
        const s = document.querySelector('.sidebar');
        const o = document.querySelector('.sidebar-overlay');
        if(open) { s.classList.add('open'); o.classList.add('open'); }
        else { s.classList.remove('open'); o.classList.remove('open'); }
    }
    
    function toggleSettings(open) {
        document.getElementById('settingsModal').classList.toggle('open', open);
    }

    function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
        // Event target fix (falls durch klick ausgel√∂st)
        if(event && event.currentTarget) event.currentTarget.classList.add('active'); 
        
        toggleSidebar(false);
        
        if(tab === 'send') document.getElementById('pageTitle').innerText = "Nachricht schreiben";
        if(tab === 'view') {
            document.getElementById('pageTitle').innerText = "Omas Sicht (Live)";
            loadViewerData(); // L√§dt Archiv
            startLiveViewer(); // Startet Live Stream <--- NEU
        }
    }
    
    function toggleDarkMode() {
        document.body.classList.toggle('dark');
        localStorage.setItem('darkmode', document.body.classList.contains('dark'));
    }

    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // --- 3. CRYPTO UTILS ---
    const enc = new TextEncoder(); const dec = new TextDecoder();
    async function getKey(p, s){ const k=await window.crypto.subtle.importKey("raw",enc.encode(p),{name:"PBKDF2"},false,["deriveKey"]); return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:s,iterations:100000,hash:"SHA-256"},k,{name:"AES-GCM",length:256},true,["encrypt","decrypt"]); }
    async function bufferToBase64(buf) { return new Promise(r => { const b=new Blob([buf]); const rd=new FileReader(); rd.onload=()=>r(rd.result.split(',')[1]); rd.readAsDataURL(b); }); }
    
    async function encryptText(txt, pass){ 
        const s=window.crypto.getRandomValues(new Uint8Array(16)); const iv=window.crypto.getRandomValues(new Uint8Array(12)); 
        const k=await getKey(pass,s); const e=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:iv},k,enc.encode(txt)); 
        const b=new Uint8Array(s.byteLength+iv.byteLength+e.byteLength); b.set(s,0); b.set(iv,16); b.set(new Uint8Array(e),28); 
        return await bufferToBase64(b); 
    }

    async function decryptText(b64, pass) {
        try {
            const bin = atob(b64); const bytes = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
            const s=bytes.slice(0,16), iv=bytes.slice(16,28), data=bytes.slice(28);
            const k=await getKey(pass,s); 
            return dec.decode(await window.crypto.subtle.decrypt({name:"AES-GCM",iv:iv},k,data));
        } catch(e){ return null; }
    }

    // --- 4. SENDER LOGIC ---
    function previewFile() {
        const f = document.getElementById('fileInput').files[0];
        const img = document.getElementById('imagePreview');
        if(f){ img.src = URL.createObjectURL(f); img.style.display='block'; document.getElementById('mediaText').innerText="√Ñndern"; }
        else { img.style.display='none'; document.getElementById('mediaText').innerText="Foto anh√§ngen"; }
    }

// --- NEU: Bild Komprimierung ---
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1200; // Genug f√ºr Omas Tablet
                    const scaleSize = MAX_WIDTH / img.width;
                    const width = (scaleSize < 1) ? MAX_WIDTH : img.width;
                    const height = (scaleSize < 1) ? img.height * scaleSize : img.height;

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Export als JPEG mit 70% Qualit√§t
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', 0.7); 
                };
                img.onerror = (e) => reject(e);
            };
            reader.onerror = (e) => reject(e);
        });
    }

    // --- NEU: Senden mit Progress ---
    async function send() {
        if(!conf.t || !conf.p) return alert("Bitte erst Einstellungen pr√ºfen!");
        
        const name = document.getElementById('senderName').value || "Familie";
        const text = document.getElementById('msgText').value;
        const fileInput = document.getElementById('fileInput').files[0];
        
        if(!text && !fileInput) return showToast("Leer?");

        // UI √∂ffnen
        const overlay = document.getElementById('progressOverlay');
        const status = document.getElementById('progressStatus');
        const bar = document.getElementById('progressBar');
        const perc = document.getElementById('progressPercent');
        
        overlay.classList.add('open');
        bar.style.width = '0%'; perc.innerText = '0%';
        
        try {
            // Schritt 1: Bild verarbeiten
            let fileToSend = null;
            if(fileInput) {
                status.innerText = "Komprimiere Bild...";
                // Kleiner Fake-Fortschritt damit man sieht dass was passiert
                bar.style.width = '20%'; 
                fileToSend = await compressImage(fileInput);
            }

            // Schritt 2: Verschl√ºsseln
            status.innerText = "Verschl√ºssele...";
            bar.style.width = '40%';
            
            // Kleines Timeout damit UI rendern kann
            await new Promise(r => setTimeout(r, 100));

            const payload = JSON.stringify({ sender: name, text: text, timestamp: Date.now() });
            const encData = await encryptText(payload, conf.p);

            // Schritt 3: Upload mit XHR (f√ºr Progress Events)
            status.innerText = "Lade hoch...";
            
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const url = `https://ntfy.sh/${conf.t}`;
                
                if (fileToSend) {
                    xhr.open('PUT', url);
                    xhr.setRequestHeader('Title', encData);
                    xhr.setRequestHeader('Filename', 'img.jpg');
                } else {
                    xhr.open('POST', url);
                }

                // Progress Handler
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        // Wir starten visuell bei 40% (nach Crypto) und gehen bis 100%
                        const realPercent = (e.loaded / e.total); 
                        const visualPercent = 40 + (realPercent * 60); 
                        bar.style.width = visualPercent + '%';
                        perc.innerText = Math.round(visualPercent) + '%';
                    }
                };

                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        // Success
                        bar.style.width = '100%';
                        status.innerText = "Fertig!";
                        setTimeout(() => {
                            overlay.classList.remove('open');
                            showToast("Gesendet! ‚úÖ");
                            document.getElementById('msgText').value = "";
                            document.getElementById('fileInput').value = "";
                            previewFile();
                            resolve();
                        }, 500);
                    } else {
                        reject("Server Fehler: " + xhr.status);
                    }
                };

                xhr.onerror = () => reject("Netzwerkfehler");
                
                // Senden
                xhr.send(fileToSend ? fileToSend : encData);
            });

        } catch(e) {
            alert("Fehler: " + e);
            overlay.classList.remove('open');
        }
    }
    

    // --- 5. VIEWER LOGIC (Simplified) ---
    let viewerMsgs = [];
    let viewerIdx = 0;

    async function loadViewerData() {
        const m = document.getElementById('viewerMeta');
        if(!conf.gu || !conf.gr || !conf.gt) {
            m.innerText = "Fehler: GitHub Infos fehlen in Einstellungen!";
            document.getElementById('viewerText').innerText = "Bitte GitHub Token in den Einstellungen hinterlegen, um den Verlauf zu sehen.";
            return;
        }
        
        m.innerText = "Lade Verlauf...";
        viewerMsgs = [];
        
        try {
            // Fetch from GitHub
            const url = `https://api.github.com/repos/${conf.gu}/${conf.gr}/contents/messages.json`;
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${conf.gt}`, 'Accept': 'application/vnd.github.v3.raw' }});
            
            if(!resp.ok) throw new Error("GitHub Zugriff verweigert");
            
            const rawData = await resp.json();
            
            // Decrypt Loop
            for(let item of rawData) {
                if(!item.enc) continue;
                const jsonStr = await decryptText(item.enc, conf.p);
                if(jsonStr) {
                    try {
                        const c = JSON.parse(jsonStr);
                        // Combine logic: GitHub base64 image > Text only
                        viewerMsgs.push({
                            ts: item.timestamp,
                            sender: c.sender || '?',
                            text: c.text || '',
                            img: item.img || null
                        });
                    } catch(e){}
                }
            }
            
            viewerMsgs.sort((a,b) => a.ts - b.ts);
            
            if(viewerMsgs.length > 0) {
                viewerIdx = viewerMsgs.length - 1; // Start at newest
                updateViewerUI();
            } else {
                m.innerText = "Archiv leer.";
                document.getElementById('viewerText').innerText = "Noch keine Nachrichten im Verlauf.";
            }

        } catch(e) {
            m.innerText = "Fehler beim Laden";
            document.getElementById('viewerText').innerText = e.message + "\n\n(Pr√ºfe Token und Repo-Name)";
        }
    }

    // --- DELETE LOGIC ---

    async function deleteMessage(ts) {
        if(!confirm("Nachricht wirklich l√∂schen?")) return;
        
        const btn = event.currentTarget;
        const originalIcon = btn.innerHTML;
        btn.innerHTML = "‚è≥"; 
        
        try {
            // 1. GitHub JSON laden
            const url = `https://api.github.com/repos/${conf.gu}/${conf.gr}/contents/messages.json`;
            const resp = await fetch(url, { 
                headers: { 'Authorization': `Bearer ${conf.gt}`, 'Accept': 'application/vnd.github.v3+json' }
            });
            
            if(!resp.ok) throw new Error("GitHub Load Error");
            
            const fileData = await resp.json();
            const cleanB64 = fileData.content.replace(/\s/g, ''); 
            const content = JSON.parse(decodeURIComponent(escape(atob(cleanB64))));
            
            // 2. Nachricht suchen ODER neu anlegen (Zombie-Schutz!)
            let foundIndex = content.findIndex(m => m.timestamp === ts);
            
            if(foundIndex !== -1) {
                // Fall A: Nachricht war schon im Archiv -> Verstecken
                content[foundIndex].hidden = true;
            } else {
                // Fall B: Nachricht ist neu (nur Live). 
                // Wir m√ºssen sie als "hidden" ins Archiv schreiben, damit der Worker sie ignoriert!
                // Wir suchen die Nachricht in unserem lokalen Viewer-Cache
                const localMsg = viewerMsgs.find(m => m.ts === ts);
                
                if(localMsg) {
                    content.push({
                        timestamp: ts,
                        enc: localMsg.enc, // Wir brauchen den encrypted string f√ºr die Struktur
                        img: null, // Bild brauchen wir nicht speichern, ist eh gel√∂scht
                        hidden: true // <--- DAS WICHTIGSTE
                    });
                    // Sortieren, damit die Ordnung stimmt
                    content.sort((a,b) => a.timestamp - b.timestamp);
                } else {
                    console.warn("Nachricht lokal nicht gefunden, l√∂sche blind.");
                }
            }

            // 3. Zur√ºck zu GitHub pushen
            const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(content))));
            const updateBody = {
                message: "Delete/Hide Message via App",
                content: newContent,
                sha: fileData.sha 
            };

            const putResp = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${conf.gt}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(updateBody)
            });

            if(!putResp.ok) throw new Error("GitHub Save Error");

            // 4. Live-Befehl an ntfy senden
            await fetch(`https://ntfy.sh/${conf.t}`, { 
                method: 'POST', 
                body: JSON.stringify({ cmd: 'DELETE', ts: ts }) 
            });

            // 5. Lokal sofort entfernen (f√ºr schnelles Feedback)
            viewerMsgs = viewerMsgs.filter(m => m.ts !== ts);
            updateViewerUI();

            alert("Gel√∂scht! üóëÔ∏è");

        } catch(e) {
            alert("Fehler: " + e.message);
        }
        if(btn) btn.innerHTML = originalIcon;
    }
    // --- UPDATE VIEWER (UI Update) ---
    // Ersetze deine alte updateViewer() Funktion hiermit:
    function updateViewer() {
        if(viewerMsgs.length === 0) return;
        const msg = viewerMsgs[viewerIdx];
        
        document.getElementById('viewerText').innerText = msg.text;
        const img = document.getElementById('viewerImg');
        if(msg.img) { img.src = msg.img; img.style.display = 'block'; }
        else { img.style.display = 'none'; }
        
        const date = new Date(msg.ts * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
        
        // NEU: M√ºlleimer Button hinzuf√ºgen
        const metaHtml = `
            <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <span>${msg.sender} ‚Ä¢ ${date} (${viewerIdx+1}/${viewerMsgs.length})</span>
                <button onclick="deleteMessage(${msg.ts})" style="background:none; border:none; cursor:pointer; font-size:16px;">üóëÔ∏è</button>
            </div>
        `;
        document.getElementById('viewerMeta').innerHTML = metaHtml;
    }
    
    // Kleiner Fix f√ºr loadViewerData, damit versteckte Nachrichten im Sender gar nicht erst angezeigt werden
    // Suche in loadViewerData() nach der "viewerMsgs.push" Zeile und f√ºge davor ein:
    // if(c.hidden) continue;  <-- NEU

    function viewerNext(dir) {
        const next = viewerIdx + dir;
        if(next >= 0 && next < viewerMsgs.length) {
            viewerIdx = next;
            updateViewer();
        }
    }
// --- LIVE VIEWER LOGIC ---
    let eventSource = null;

    function startLiveViewer() {
        if(eventSource) return; // L√§uft schon
        if(!conf.t) return;

        console.log("Starte Live-Viewer...");
        eventSource = new EventSource(`https://ntfy.sh/${conf.t}/sse?since=all`);
        
        eventSource.onmessage = async (e) => {
            const data = JSON.parse(e.data);
            if(data.event === 'message') {
                
                // 1. Check auf Delete-Command
                try {
                    const cmd = JSON.parse(data.message);
                    if(cmd.cmd === 'DELETE') {
                        // Nachricht lokal aus der Liste entfernen
                        viewerMsgs = viewerMsgs.filter(m => m.ts !== cmd.ts);
                        updateViewerUI(); // UI refreshen
                        return;
                    }
                } catch(err){}

                // 2. Normale Nachricht verarbeiten
                const ts = data.time;
                // Haben wir die schon? (Deduplizierung)
                if(viewerMsgs.some(m => m.ts === ts)) return;

                let encPayload = data.attachment ? data.title : data.message;
                let imgData = data.attachment ? data.attachment.url : null;
                
                if(!encPayload) return;

                // Entschl√ºsseln
                const jsonStr = await decryptText(encPayload, conf.p);
                if(jsonStr) {
                    try {
                        const c = JSON.parse(jsonStr);
                        // Nachricht zur Liste hinzuf√ºgen
                        viewerMsgs.push({
                            ts: ts,
                            sender: c.sender || '?',
                            text: c.text || '',
                            img: imgData || c.image || null, // Nimm Live-URL oder Base64
                            enc: encPayload // Wichtig f√ºr Smart-Delete!
                        });

                        // Neu sortieren
                        viewerMsgs.sort((a,b) => a.ts - b.ts);
                        
                        // Wenn wir gerade die neueste ansehen, spring mit
                        if(viewerIdx >= viewerMsgs.length - 2) {
                            viewerIdx = viewerMsgs.length - 1;
                        }
                        updateViewerUI(); // UI Refresh (statt updateViewer)

                    } catch(e) { console.error(e); }
                }
            }
        };
    }

    // Hilfsfunktion: UI Update ohne Index-Reset
    function updateViewerUI() {
        if(viewerMsgs.length === 0) {
            document.getElementById('viewerMeta').innerText = "Warte auf Nachrichten...";
            document.getElementById('viewerText').innerText = "";
            document.getElementById('viewerImg').style.display = 'none';
            return;
        }
        // Index Bounds Check (falls wir gel√∂scht haben)
        if(viewerIdx >= viewerMsgs.length) viewerIdx = viewerMsgs.length - 1;
        if(viewerIdx < 0) viewerIdx = 0;

        const msg = viewerMsgs[viewerIdx];
        document.getElementById('viewerText').innerText = msg.text;
        const img = document.getElementById('viewerImg');
        if(msg.img) { img.src = msg.img; img.style.display = 'block'; }
        else { img.style.display = 'none'; }
        
        const date = new Date(msg.ts * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        // Delete Button
        const metaHtml = `
            <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <span>${msg.sender} ‚Ä¢ ${date} (${viewerIdx+1}/${viewerMsgs.length})</span>
                <button onclick="deleteMessage(${msg.ts})" style="background:none; border:none; cursor:pointer; font-size:16px;">üóëÔ∏è</button>
            </div>
        `;
        document.getElementById('viewerMeta').innerHTML = metaHtml;
    }


    
</script>
</body>
</html>
