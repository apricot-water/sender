<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Nachricht an Oma</title>
<style>
    /* === MODERN THEME VARIABLES === */
    :root {
        --bg-app: #f2f2f7;
        --bg-card: #ffffff;
        --text-main: #000000;
        --text-sub: #8e8e93;
        --input-bg: #e5e5ea;
        --accent: #007aff;
        --accent-gradient: linear-gradient(135deg, #007aff, #005ecb);
        --danger: #ff3b30;
        --radius: 16px;
    }

    body.dark {
        --bg-app: #000000;
        --bg-card: #1c1c1e;
        --text-main: #ffffff;
        --text-sub: #98989f;
        --input-bg: #2c2c2e;
        --accent: #0a84ff;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-app);
        color: var(--text-main);
        margin: 0; padding: 0;
        /* WICHTIG: Kein Scrollen auf dem Body */
        height: 100dvh; 
        width: 100vw;
        overflow: hidden;
        display: flex; justify-content: center;
    }

    /* === APP FRAME === */
    .app-wrapper {
        width: 100%; max-width: 600px;
        background: var(--bg-card);
        display: flex; flex-direction: column;
        height: 100%;
        position: relative; /* Wichtig fÃ¼r Modal */
        overflow: hidden;   /* Wichtig damit Modal nicht sichtbar drunter hÃ¤ngt */
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    /* === HEADER === */
    .app-header {
        flex: 0 0 auto; /* Darf nicht schrumpfen */
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 20px;
        background: var(--bg-card);
        border-bottom: 1px solid var(--input-bg);
        z-index: 10;
    }
    .app-title { font-size: 17px; font-weight: 700; }
    .btn-icon { background: none; border: none; cursor: pointer; color: var(--accent); padding: 5px; }

    /* === SCROLL CONTENT === */
    .content-area {
        flex: 1; 
        overflow-y: auto; /* Nur HIER darf gescrollt werden */
        padding: 20px;
        display: flex; flex-direction: column; gap: 20px;
        -webkit-overflow-scrolling: touch;
    }

    /* === INPUTS === */
    input, textarea {
        width: 100%; background: var(--input-bg); border: none; color: var(--text-main);
        padding: 16px; border-radius: 12px; font-size: 17px; font-family: inherit; resize: none;
    }
    input:focus, textarea:focus { outline: none; box-shadow: 0 0 0 2px var(--accent); }
    .label-small { font-size: 13px; color: var(--text-sub); margin-left: 12px; margin-bottom: 6px; font-weight: 500; text-transform: uppercase; }

    /* === MEDIA BOX === */
    .media-upload {
        background: var(--input-bg); border-radius: 12px; padding: 20px;
        text-align: center; cursor: pointer; border: 2px dashed rgba(128,128,128,0.3);
        transition: 0.2s;
    }
    .media-upload:active { background: rgba(128,128,128,0.1); }
    .media-preview-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; display: none; margin-top: 10px; }

    /* === BOTTOM BAR === */
    .bottom-bar {
        flex: 0 0 auto; padding: 20px;
        background: var(--bg-card); border-top: 1px solid var(--input-bg);
        /* Keyboard fix iOS */
        padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
    .btn-primary {
        width: 100%; background: var(--accent-gradient); color: white;
        font-size: 17px; font-weight: 600; padding: 14px; border: none; border-radius: 12px;
        cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary:active { opacity: 0.8; transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.5; cursor: default; }

    /* === SETTINGS MODAL (OVERLAY) === */
    #settingsModal {
        position: absolute; 
        top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-card);
        z-index: 50;
        display: flex; flex-direction: column;
        
        /* Animation: Slide Up */
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    #settingsModal.open { transform: translateY(0); }

    .setting-item { background: var(--input-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .setting-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 600; }
    .copy-link { color: var(--accent); cursor: pointer; }
    
    /* Toggle Switch */
    .switch-row { display: flex; justify-content: space-between; align-items: center; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(22px); }

    /* Toast */
    #toast {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
        background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; border-radius: 30px;
        font-weight: 600; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 100;
    }
    #toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
</style>
</head>
<body>

<div class="app-wrapper">
    
    <!-- HEADER -->
    <header class="app-header">
        <div class="app-title">ðŸ‘µ an Oma</div>
        <!-- Modernes Zahnrad Icon -->
        <button class="btn-icon" onclick="toggleSettings(true)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
    </header>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal">
        <header class="app-header">
            <div class="app-title">Einstellungen</div>
            <button class="btn-icon" onclick="saveConf()">Fertig</button>
        </header>
        <div class="content-area">
            
            <div class="setting-item switch-row">
                <span>ðŸŒ™ Dark Mode</span>
                <label class="switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <span>Kanal Name</span>
                    <span class="copy-link" onclick="copyToClip('topic')">Kopieren</span>
                </div>
                <input id="topic" placeholder="oma_geheim" oninput="validateTopic(this)" style="font-family:monospace">
                <div id="topicWarn" style="font-size:11px; margin-top:5px; color:var(--text-sub);">Max. 39 Zeichen</div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <span>Passwort</span>
                    <span class="copy-link" onclick="copyToClip('pass')">Kopieren</span>
                </div>
                <input id="pass" type="text" placeholder="Geheim">
            </div>
        </div>
    </div>

    <!-- MAIN CHAT -->
    <div class="content-area">
        <div>
            <div class="label-small">Absender</div>
            <input id="senderName" placeholder="Dein Name">
        </div>

        <div style="flex:1; display:flex; flex-direction:column;">
            <div class="label-small">Nachricht</div>
            <textarea id="msgText" placeholder="Schreib was..." style="flex:1; min-height:120px;"></textarea>
        </div>

        <div class="media-upload" onclick="document.getElementById('fileInput').click()">
            <div style="font-size:24px; opacity:0.5">ðŸ“·</div>
            <div id="mediaText" style="font-weight:600; color:var(--accent); margin-top:5px">Foto hinzufÃ¼gen</div>
            <img id="imagePreview" class="media-preview-img">
            <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewFile()">
        </div>
    </div>

    <!-- FOOTER -->
    <div class="bottom-bar">
        <button id="btnSend" class="btn-primary" onclick="send()">
            Senden ðŸš€
        </button>
    </div>

    <!-- NOTIFICATION -->
    <div id="toast">Nachricht gesendet!</div>

</div>

<script>
      // --- MAGIC LINK AUTO-LOGIN (Ganz oben einfÃ¼gen) ---
    (function checkMagicLink() {
        // Wir schauen, ob im Link hinter #config= etwas steht
        const hash = window.location.hash;
        if (hash.startsWith('#config=')) {
            try {
                // Den Teil nach dem = holen
                const base64Str = hash.substring(8);
                // Base64 zu Text decodieren (atob)
                const jsonStr = atob(base64Str);
                const conf = JSON.parse(jsonStr);
                
                // PrÃ¼fen ob Format stimmt
                if(conf.t && conf.p) {
                    localStorage.setItem('oma_sender_conf', JSON.stringify(conf));
                    // URL sÃ¤ubern (damit man das Passwort nicht mehr sieht)
                    history.replaceState(null, null, window.location.pathname);
                    // Seite neu laden damit die Werte in die Felder kommen
                    location.reload(); 
                }
            } catch (e) {
                console.error("Magic Link ungÃ¼ltig", e);
                alert("Der Link war fehlerhaft.");
            }
        }
    })();

    // --- BASIC SETUP ---
    let conf = JSON.parse(localStorage.getItem('oma_sender_conf')) || { t: '', p: '' };
    document.getElementById('topic').value = conf.t;
    document.getElementById('pass').value = conf.p;
    
    if (localStorage.getItem('darkmode') === 'true') {
        document.body.classList.add('dark');
        document.getElementById('darkModeToggle').checked = true;
    }
    if (!conf.t || !conf.p) toggleSettings(true);

    // --- UI FUNCTIONS ---
    function toggleSettings(forceOpen = false) {
        const m = document.getElementById('settingsModal');
        if (forceOpen) m.classList.add('open');
        else m.classList.toggle('open');
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark');
        localStorage.setItem('darkmode', document.body.classList.contains('dark'));
    }

    function validateTopic(input) {
        const val = input.value;
        const warn = document.getElementById('topicWarn');
        if (val.length > 39) {
            input.value = val.substring(0, 39);
            warn.style.color = 'var(--danger)'; warn.innerText = "Limit erreicht!";
        } else if (/[^a-zA-Z0-9-_]/.test(val)) {
            warn.style.color = 'orange'; warn.innerText = "Nur a-z, 0-9, - und _";
        } else {
            warn.style.color = 'var(--text-sub)'; warn.innerText = "Max. 39 Zeichen";
        }
    }

    function copyToClip(id) {
        navigator.clipboard.writeText(document.getElementById(id).value);
        showToast("Kopiert!");
    }

    function saveConf() {
        const t = document.getElementById('topic').value.trim();
        const p = document.getElementById('pass').value.trim();
        if(t.length > 40) return alert("Topic zu lang!");
        if(!t || !p) return alert("Bitte ausfÃ¼llen!");
        localStorage.setItem('oma_sender_conf', JSON.stringify({t, p}));
        document.getElementById('settingsModal').classList.remove('open');
    }

    function previewFile() {
        const file = document.getElementById('fileInput').files[0];
        const img = document.getElementById('imagePreview');
        if (file) { img.src = URL.createObjectURL(file); img.style.display = 'block'; document.getElementById('mediaText').innerText = "Foto Ã¤ndern"; }
        else { img.style.display = 'none'; document.getElementById('mediaText').innerText = "Foto hinzufÃ¼gen"; }
    }

    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // --- LOGIC (SAME AS BEFORE) ---
    const enc = new TextEncoder();
    function bufferToBase64(buffer) { return new Promise(r => { const b=new Blob([buffer]); const reader=new FileReader(); reader.onload=()=>r(reader.result.split(',')[1]); reader.readAsDataURL(b); }); }
    async function getKey(p,s){ const k=await window.crypto.subtle.importKey("raw",enc.encode(p),{name:"PBKDF2"},false,["deriveKey"]); return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:s,iterations:100000,hash:"SHA-256"},k,{name:"AES-GCM",length:256},true,["encrypt","decrypt"]); }
    async function encryptText(t,p){ const s=window.crypto.getRandomValues(new Uint8Array(16)); const iv=window.crypto.getRandomValues(new Uint8Array(12)); const k=await getKey(p,s); const e=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:iv},k,enc.encode(t)); const b=new Uint8Array(s.byteLength+iv.byteLength+e.byteLength); b.set(s,0); b.set(iv,16); b.set(new Uint8Array(e),28); return await bufferToBase64(b); }

    async function send() {
        const conf = JSON.parse(localStorage.getItem('oma_sender_conf'));
        if(!conf || !conf.t || !conf.p) return alert("Einstellungen prÃ¼fen!");
        
        const sender = document.getElementById('senderName').value || "Jemand";
        const text = document.getElementById('msgText').value;
        const file = document.getElementById('fileInput').files[0];
        const btn = document.getElementById('btnSend');

        if(!text && !file) return showToast("Text oder Bild fehlt!");

        btn.disabled = true; btn.innerText = "Sende...";

        try {
            const encData = await encryptText(JSON.stringify({sender, text}), conf.p);
            
            if (file) {
                await fetch(`https://ntfy.sh/${conf.t}`, { method: 'PUT', body: file, headers: { 'Title': encData, 'Filename': 'foto.jpg' } });
            } else {
                await fetch(`https://ntfy.sh/${conf.t}`, { method: 'POST', body: encData });
            }

            showToast("Gesendet! âœ…");
            document.getElementById('msgText').value = "";
            document.getElementById('fileInput').value = "";
            previewFile();
            btn.innerText = "Senden ðŸš€"; btn.disabled = false;
        } catch(e) {
            alert("Fehler: " + e.message); btn.disabled = false;
        }
    }
</script>
</body>
</html>
