<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An Oma senden</title>
<style>
    body { font-family: sans-serif; padding: 20px; background: #f0f2f5; max-width: 600px; margin: auto; }
    input, textarea, button { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #2196f3; color: white; font-weight: bold; border: none; cursor: pointer; }
    button:active { transform: scale(0.98); }
    .hidden { display: none; }
</style>
</head>
<body>

    <h2>ðŸ‘µ Nachricht an Oma</h2>

    <div id="setupBox">
        <input id="topic" placeholder="Kanal Name (Muss gleich sein wie bei Oma!)">
        <input id="pass" type="password" placeholder="Passwort (Muss gleich sein!)">
        <button onclick="saveConf()">Speichern</button>
    </div>

    <div id="sendBox" class="hidden">
        <input id="senderName" placeholder="Dein Name (z.B. Max)">
        <textarea id="msgText" rows="4" placeholder="Nachricht schreiben..."></textarea>
        
        <label style="display:block; margin-bottom:10px; font-weight:bold;">
            ðŸ“· Foto (Optional):
            <input type="file" id="fileInput" accept="image/*" style="margin-top:5px;">
        </label>

        <button onclick="send()" id="btnSend">Absenden ðŸš€</button>
        <div id="status" style="margin-top:10px; text-align:center;"></div>
        <br><br>
        <button onclick="clearConf()" style="background:#666; font-size:12px;">Einstellungen zurÃ¼cksetzen</button>
    </div>

<!-- ... (HTML Teil bleibt gleich) ... -->

<script>
    // --- CRYPTO LOGIC (GLEICH) ---
    const enc = new TextEncoder();
    async function getKey(password, salt) {
        const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
        return window.crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
    }
    
    function bufferToBase64(buffer) {
        return new Promise((resolve) => {
            const blob = new Blob([buffer]);
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(blob);
        });
    }

    async function encryptText(text, password) {
        const salt = window.crypto.getRandomValues(new Uint8Array(16));
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const key = await getKey(password, salt);
        const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(text));
        
        const buffer = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
        buffer.set(salt, 0); buffer.set(iv, 16); buffer.set(new Uint8Array(encrypted), 28);
        return await bufferToBase64(buffer);
    }

    // --- APP LOGIC ---
    if(localStorage.getItem('oma_sender_conf')) {
        document.getElementById('setupBox').classList.add('hidden');
        document.getElementById('sendBox').classList.remove('hidden');
    }

    function saveConf() {
        const t = document.getElementById('topic').value;
        const p = document.getElementById('pass').value;
        if(t && p) {
            localStorage.setItem('oma_sender_conf', JSON.stringify({t, p}));
            location.reload();
        }
    }
    
    function clearConf() { localStorage.removeItem('oma_sender_conf'); location.reload(); }

    async function send() {
        const conf = JSON.parse(localStorage.getItem('oma_sender_conf'));
        const sender = document.getElementById('senderName').value || "Jemand";
        const text = document.getElementById('msgText').value;
        const fileInput = document.getElementById('fileInput');
        const btn = document.getElementById('btnSend');
        const status = document.getElementById('status');

        if(!text && !fileInput.files[0]) return alert("Schreib was oder wÃ¤hl ein Bild!");

        btn.disabled = true;
        btn.innerText = "VerschlÃ¼ssle...";

        try {
            // 1. Nutzdaten vorbereiten
            const payload = { sender: sender, text: text };
            const jsonStr = JSON.stringify(payload);
            
            // 2. Text verschlÃ¼sseln
            const encryptedData = await encryptText(jsonStr, conf.p);

            btn.innerText = "Sende...";
            
            // 3. Entscheidung: Mit Bild oder ohne?
            if (fileInput.files[0]) {
                // === MIT BILD (Upload als File, Text im Header) ===
                // Wichtig: Der verschlÃ¼sselte String muss in den "Title" Header, 
                // weil der Body jetzt das Bild ist.
                await fetch(`https://ntfy.sh/${conf.t}`, {
                    method: 'PUT',
                    body: fileInput.files[0],
                    headers: {
                        'Title': encryptedData, // Hier steckt der verschlÃ¼sselte Text!
                        'Filename': 'foto.jpg'
                    }
                });
            } else {
                // === NUR TEXT (Standard) ===
                await fetch(`https://ntfy.sh/${conf.t}`, {
                    method: 'POST',
                    body: encryptedData // Text ist der Body
                });
            }

            status.innerText = "âœ… Gesendet!";
            document.getElementById('msgText').value = "";
            document.getElementById('fileInput').value = "";
            setTimeout(() => { status.innerText=""; btn.innerText="Absenden ðŸš€"; btn.disabled=false; }, 2000);

        } catch(e) {
            alert("Fehler: " + e.message);
            btn.disabled = false;
            btn.innerText = "Absenden ðŸš€";
        }
    }
</script>
</body>
</html>
